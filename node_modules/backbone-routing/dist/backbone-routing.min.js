!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("backbone"),require("backbone-metal")):"function"==typeof define&&define.amd?define(["backbone","backbone-metal"],t):e.Backbone.Routing=t(e.Backbone,e.Metal)}(this,function(e,t){"use strict";var r=t.Error.extend({name:"CancellationError"}),n=t.Class.extend({enter:function(){var e=this,t=void 0===arguments[0]?[]:arguments[0];return this._isEntering=!0,this.trigger.apply(this,["before:enter before:fetch",this].concat(t)),Promise.resolve().then(function(){return e._isCancelled?Promise.reject(new r):e.fetch.apply(e,t)}).then(function(){return e.trigger.apply(e,["fetch before:render",e].concat(t))}).then(function(){return e._isCancelled?Promise.reject(new r):e.render.apply(e,t)}).then(function(){e._isEntering=!1,e.trigger.apply(e,["render enter",e].concat(t))})["catch"](function(t){if(e._isEntering=!1,!(t instanceof r))throw e.trigger("error error:enter",e,t),t;e.trigger("cancel",e)})},exit:function(){var e=this;return this._isEntering&&this.cancel(),this._isExiting=!0,this.trigger("before:exit before:destroy",this),Promise.resolve().then(function(){return e.destroy()}).then(function(){e._isExiting=!1,e.trigger("destroy exit",e),e.stopListening()})["catch"](function(t){throw e._isExiting=!1,e.trigger("error error:exit",e,t),e.stopListening(),t})},cancel:function(){var e=this;if(this._isEntering)return this.trigger("before:cancel",this),this._isCancelled=!0,new Promise(function(t,r){e.once("cancel",t),e.once("enter error",r)})},isEntering:function(){return!!this._isEntering},isExiting:function(){return!!this._isExiting},isCancelled:function(){return!!this._isCancelled},fetch:function(){},render:function(){},destroy:function(){}}),i=t.Class.extend(e.Router.prototype,e.Router).extend({constructor:function(){this.listenTo(e.history,"route",this._onHistoryRoute),this._super.apply(this,arguments)},isActive:function(){return!!this._isActive},execute:function(t,r){var n=this,i=!this._isActive;return i&&this.trigger("before:enter",this),this.trigger("before:route",this),Promise.resolve().then(function(){return n._execute(t,r)}).then(function(){n.trigger("route",n),i&&n.trigger("enter",n)})["catch"](function(t){throw n.trigger("error",n,t),e.history.trigger("error",n,t),t})},_execute:function(e,t){var r=this;return Promise.resolve().then(function(){return i._prevRoute instanceof n?i._prevRoute.exit():void 0}).then(function(){var o=i._prevRoute=e.apply(r,t);return o instanceof n?(o.router=r,o.enter(t)):void 0})},_onHistoryRoute:function(e){this._isActive=e===this}},{_prevRoute:null}),o={Route:n,Router:i,CancellationError:r};return o});
//# sourceMappingURL=backbone-routing.min.js.map